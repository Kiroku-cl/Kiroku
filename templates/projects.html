<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyectos - HILO</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/static/base.css">
    <link rel="stylesheet" href="/static/projects.css">
</head>
<body>
    {% set active_page = 'projects' %}
    {% include 'partials/navbar.html' %}

    <div class="projects-container">
        <div class="projects-header">
            <h1>Mis Proyectos</h1>
        </div>

        <!-- FAB para mobile -->
        <a href="{{ url_for('pages.record_page') }}" class="fab-new" title="Nueva grabación">
            <i class="bi bi-plus-lg"></i>
        </a>

        <div id="projects-list" class="projects-list">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Cargando proyectos...</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const icons = {
                error: 'bi-exclamation-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                success: 'bi-check-circle-fill',
                info: 'bi-info-circle-fill'
            };
            
            toast.innerHTML = `
                <i class="bi ${icons[type]} toast-icon ${type}"></i>
                <span class="toast-message">${message}</span>
                <button class="toast-close"><i class="bi bi-x"></i></button>
            `;
            
            container.appendChild(toast);
            
            const closeBtn = toast.querySelector('.toast-close');
            const removeToast = () => {
                toast.classList.add('toast-out');
                setTimeout(() => toast.remove(), 300);
            };
            
            closeBtn.addEventListener('click', removeToast);
            setTimeout(removeToast, duration);
        }

        function formatDate(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatExpires(isoString) {
            if (!isoString) return 'Sin expiración';
            const now = new Date();
            const expires = new Date(isoString);
            if (Number.isNaN(expires.getTime())) return 'Sin expiración';

            const diffMs = expires - now;
            if (diffMs <= 0) return 'Expirado';

            const diffHours = Math.ceil(diffMs / (1000 * 60 * 60));
            if (diffHours < 24) {
                return `Expira en ${diffHours} hora${diffHours === 1 ? '' : 's'}`;
            }

            const diffDays = Math.ceil(diffHours / 24);
            return `Expira en ${diffDays} día${diffDays === 1 ? '' : 's'}`;
        }

        function getStatusClass(project) {
            const status = project.status || (project.is_active ? 'recording' : project.job_status);
            if (status === 'recording') return 'recording';
            if (status === 'queued') return 'processing';
            if (status === 'processing') return 'processing';
            if (status === 'done') return 'done';
            if (status === 'error') return 'error';
            return 'done';
        }

        function getStatusText(project) {
            const status = project.status || (project.is_active ? 'recording' : project.job_status);
            if (status === 'recording') return 'Grabando';
            if (status === 'queued') return 'En cola';
            if (status === 'processing') return 'En proceso';
            if (status === 'done') return 'Finalizado';
            if (status === 'error') return 'Error';
            return 'Finalizado';
        }

        function getRetentionTag(project) {
            if (!project.expires_at) return null;
            const label = formatExpires(project.expires_at);
            if (!label || label === 'Sin expiración') return null;
            return label;
        }

        let pollingInterval = null;

        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            const processingCards = document.querySelectorAll(
                '.project-card[data-job-status="queued"], .project-card[data-job-status="processing"]'
            );
            if (processingCards.length === 0) return;

            pollingInterval = setInterval(async () => {
                const cards = document.querySelectorAll('.project-card[data-job-status="processing"]');
                
                if (cards.length === 0) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    return;
                }

                for (const card of cards) {
                    const projectId = card.dataset.projectId;
                    if (!projectId) continue;

                    try {
                        const res = await fetch(`/api/project/${projectId}/status`);
                        const data = await res.json();

                        if (data.ok && !['queued', 'processing'].includes(data.status)) {
                            updateProjectCard(card, data.status);
                        }
                    } catch (err) {
                        console.warn('Polling error:', err);
                    }
                }
            }, 3000);
        }

        function updateProjectCard(card, newStatus) {
            card.dataset.jobStatus = newStatus;

            const statusBadge = card.querySelector('.project-status');
            if (statusBadge) {
                const badgeClass = newStatus === 'queued' ? 'processing' : newStatus;
                statusBadge.className = `project-status ${badgeClass}`;
                statusBadge.textContent = newStatus === 'done' ? 'Finalizado' : 
                                          newStatus === 'error' ? 'Error' :
                                          newStatus === 'queued' ? 'En cola' :
                                          newStatus;
            }

            const actionsDiv = card.querySelector('.project-actions');
            const projectId = card.dataset.projectId;
            
            if (newStatus === 'done' && actionsDiv && projectId) {
                const stateBtn = actionsDiv.querySelector('.btn-action.secondary:not([style])');
                if (stateBtn && stateBtn.textContent.includes('Ver Estado')) {
                    stateBtn.outerHTML = `
                        <a href="/r/${projectId}" class="btn-action primary">
                            <i class="bi bi-file-earmark-text"></i>
                            Ver Guion
                        </a>
                    `;
                }
                showToast('¡Guion generado!', 'success');
            } else if (newStatus === 'error') {
                showToast('Error al generar guion', 'error');
            }
        }

        async function loadProjects() {
            const container = document.getElementById('projects-list');
            
            try {
                const res = await fetch('/api/projects');
                const data = await res.json();
                
                if (!data.ok) {
                    throw new Error(data.error || 'Error loading projects');
                }
                
                if (data.projects.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-folder2-open"></i>
                            <h2>No hay proyectos</h2>
                            <p>Crea una nueva grabación para comenzar</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.projects.map(s => `
                    <div class="project-card" data-id="${s.project_id}" data-project-id="${s.project_id}" data-job-status="${s.job_status || ''}">
                        <div class="project-header">
                            <div>
                                <h3 class="project-title">${s.project_name || 'Sin título'}</h3>
                                ${s.participant_name ? `<span class="project-participant">${s.participant_name}</span>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="project-status ${getStatusClass(s)}">
                                    ${getStatusText(s)}
                            </span>
                                ${getRetentionTag(s) ? `<span class="project-tag retention">${getRetentionTag(s)}</span>` : ''}
                                ${s.stylize_errors > 0 ? `<span class="project-tag warning" title="${s.stylize_errors} foto(s) no se pudieron estilizar">⚠ Fotos</span>` : ''}
                            </div>
                        </div>
                        <div class="project-meta">
                            <span class="project-meta-item">
                                <i class="bi bi-calendar"></i>
                                ${formatDate(s.created_at)}
                            </span>
                            <span class="project-meta-item">
                                <i class="bi bi-hourglass-split"></i>
                                ${formatExpires(s.expires_at)}
                            </span>
                            <span class="project-meta-item">
                                <i class="bi bi-mic"></i>
                                ${s.chunk_count} chunks
                            </span>
                            <span class="project-meta-item">
                                <i class="bi bi-camera"></i>
                                ${s.photo_count} fotos
                            </span>
                            <span class="project-meta-item">
                                <i class="bi bi-file-text"></i>
                                ${s.transcript_length} caracteres
                            </span>
                        </div>
                        <div class="project-actions">
                            ${s.job_status === 'done' ? `
                                <a href="/r/${s.project_id}" class="btn-action primary">
                                    <i class="bi bi-file-earmark-text"></i>
                                    Ver Guion
                                </a>
                            ` : ''}
                            ${['queued', 'processing'].includes(s.job_status) ? `
                                <a href="/r/${s.project_id}" class="btn-action secondary">
                                    <i class="bi bi-hourglass-split"></i>
                                    Ver Estado
                                </a>
                            ` : ''}
                            ${s.is_active ? `
                                <span class="btn-action secondary" style="cursor: default;">
                                    <i class="bi bi-record-circle"></i>
                                    Grabando
                                </span>
                            ` : ''}
                            <button class="btn-action danger" onclick="confirmDelete('${s.project_id}', '${(s.project_name || 'Sin título').replace(/'/g, "\\'")}')">
                                <i class="bi bi-trash"></i>
                                Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
                
                startPolling();
                
            } catch (err) {
                console.error('Error loading projects:', err);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h2>Error al cargar</h2>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        function confirmDelete(projectId, projectName) {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
                <div class="confirm-dialog">
                    <h3>¿Eliminar proyecto?</h3>
                    <p>Se eliminará permanentemente "<strong>${projectName}</strong>" y todos sus archivos asociados.</p>
                    <div class="confirm-actions">
                        <button class="btn-action secondary" onclick="this.closest('.confirm-overlay').remove()">
                            Cancelar
                        </button>
                        <button class="btn-action primary" onclick="deleteProject('${projectId}')">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        async function deleteProject(projectId) {
            document.querySelector('.confirm-overlay')?.remove();
            
            try {
                const res = await fetch(`/api/project/${projectId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (!data.ok) {
                    throw new Error(data.error || 'Error deleting project');
                }
                
                showToast('Proyecto eliminado', 'success');
                
                document.querySelector(`.project-card[data-id="${projectId}"]`)?.remove();
                
                const container = document.getElementById('projects-list');
                if (!container.querySelector('.project-card')) {
                    loadProjects();
                }
                
            } catch (err) {
                console.error('Error deleting project:', err);
                showToast(err.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadProjects);
    </script>
</body>
</html>
