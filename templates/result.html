<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.project_name or 'Resultado' }} - HILO</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/static/base.css">
    <link rel="stylesheet" href="/static/result.css">
</head>
<body>
    <div class="page-header">
        <a href="/" class="logo">HILO</a>
        <div class="header-actions">
            <a href="/projects" class="btn btn-secondary">
                <i class="bi bi-folder2"></i>
                Proyectos
            </a>
        </div>
    </div>

    <div class="result-container">
        {% if project.status in ['queued', 'processing'] %}
        <div class="card">
            <div class="spinner"></div>
            <h1>Procesando...</h1>
            <p class="subtitle">Generando tu guión. Esto puede tomar unos segundos.</p>
        </div>
        
        {% elif project.status == 'done' %}
        <div class="card">
            <div class="status-icon done">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <h1>¡Guion listo!</h1>
            <p class="subtitle">{{ project.project_name or 'Tu guión' }} ha sido generado exitosamente.</p>
            
            <div class="header-actions" style="justify-content: center;">
                {% if project.output_file %}
                <a href="/r/{{ project.project_id }}/download/{{ project.output_file }}" class="btn btn-secondary">
                    <i class="bi bi-download"></i>
                    Descargar MD
                </a>
                {% endif %}
                
                {% if project.fallback_file %}
                <a href="/r/{{ project.project_id }}/download/{{ project.fallback_file }}" class="btn btn-secondary">
                    <i class="bi bi-file-text"></i>
                    Transcripción
                </a>
                {% endif %}
                
                <button onclick="copyPreview()" class="btn btn-primary">
                    <i class="bi bi-clipboard"></i>
                    Copiar
                </button>
            </div>

            <div class="preview-section">
                <div class="preview-header">
                    <h2>Vista previa</h2>
                    <div class="tabs">
                        <button class="tab active" onclick="setTheme('light')">Claro</button>
                        <button class="tab" onclick="setTheme('dark')">Oscuro</button>
                    </div>
                </div>
                <div id="preview-content" class="preview-content light">
                    Cargando...
                </div>
            </div>
        </div>
        
        {% elif project.status == 'error' %}
        <div class="card">
            <div class="status-icon error">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>
            <h1>Error al procesar</h1>
            
            {% if project.error %}
            <div class="error-msg">{{ project.error }}</div>
            {% endif %}
            
            <p class="subtitle">Hubo un problema generando el guion.</p>
            
            <div class="header-actions" style="justify-content: center;">
                {% if project.fallback_file %}
                <a href="/r/{{ project.project_id }}/download/{{ project.fallback_file }}" class="btn btn-primary">
                    <i class="bi bi-download"></i>
                    Descargar Transcripción
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div id="copy-toast" class="copy-toast">
        <i class="bi bi-check-lg"></i> Copiado al portapapeles
    </div>

    {% if project.status in ['queued', 'processing'] %}
    <script>
        setInterval(async () => {
            try {
                const res = await fetch('/api/project/{{ project.project_id }}/status');
                const data = await res.json();
                if (data.ok && !['queued', 'processing'].includes(data.status)) {
                    window.location.reload();
                }
            } catch (err) {
                console.warn('Polling error:', err);
            }
        }, 2000);
    </script>
    {% endif %}

    {% if project.status == 'done' %}
    <script>
        const projectId = '{{ project.project_id }}';
        
        async function loadPreview() {
            try {
                const res = await fetch(`/api/project/${projectId}/preview`);
                const data = await res.json();
                
                if (data.ok) {
                    document.getElementById('preview-content').innerHTML = data.html;
                } else {
                    document.getElementById('preview-content').textContent = 'Error cargando preview';
                }
            } catch (err) {
                console.error('Error loading preview:', err);
                document.getElementById('preview-content').textContent = 'Error cargando preview';
            }
        }
        
        async function copyPreview() {
            const preview = document.getElementById('preview-content');
            
            try {
                const range = document.createRange();
                range.selectNodeContents(preview);
                
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                document.execCommand('copy');
                
                selection.removeAllRanges();
                
                const toast = document.getElementById('copy-toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
                
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Error al copiar. Intenta seleccionar manualmente.');
            }
        }
        
        function setTheme(theme) {
            const preview = document.getElementById('preview-content');
            preview.classList.remove('light', 'dark');
            preview.classList.add(theme);
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        loadPreview();
    </script>
    {% endif %}
</body>
</html>
