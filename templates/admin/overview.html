{% extends "base.html" %}

{% block title %}Admin Overview - HILO{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div>
            <h1 class="admin-title">Admin Overview</h1>
        </div>
    </div>

    {% include "admin/partials/nav.html" %}

    <div class="admin-grid" id="overview-grid">
        <div class="admin-card metric-card warning">
            <h3>Jobs en proceso</h3>
            <div class="metric" id="stat-jobs-processing">--</div>
        </div>
        <div class="admin-card metric-card error">
            <h3>Jobs en error</h3>
            <div class="metric" id="stat-jobs-error">--</div>
        </div>
        <div class="admin-card metric-card accent-light">
            <h3>Imágenes en proceso</h3>
            <div class="metric" id="stat-images-processing">--</div>
        </div>
    </div>

    <div class="chart-panel">
        <div class="chart-card">
            <div class="admin-header" style="margin-bottom: 12px;">
                <div>
                    <h3>Proyectos por hora</h3>
                </div>
                <div class="filter-bar" style="grid-template-columns: 1fr auto; gap: 8px;">
                    <input type="date" class="form-control" id="projects-date" style="height: 32px;">
                    <button class="btn btn-action primary" id="projects-date-apply" style="padding: 6px 12px; font-size: 12px; height: 32px;">Aplicar</button>
                </div>
            </div>
            <canvas id="projects-hourly-chart" height="120"></canvas>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
    let hourlyChart = null;
    let costChart = null;

    async function loadOverview() {
        const res = await fetch('/api/admin/overview');
        const data = await res.json();
        if (!data.ok) return;

        const stats = data.stats || {};
        document.getElementById('stat-jobs-processing').textContent = stats.jobs_processing ?? 0;
        document.getElementById('stat-jobs-error').textContent = stats.jobs_error ?? 0;
        document.getElementById('stat-images-processing').textContent = stats.images_processing ?? 0;
    }

    function formatDateInput(date) {
        return date.toISOString().split('T')[0];
    }

    async function loadHourlyProjects(dateValue) {
        const res = await fetch(`/api/admin/overview/projects-hourly?date=${dateValue}`);
        const data = await res.json();
        if (!data.ok) return;

        const labels = data.hours || [];
        const projectCounts = data.project_counts || [];
        const photoCounts = data.photo_counts || [];

        const ctx = document.getElementById('projects-hourly-chart');
        if (hourlyChart) {
            hourlyChart.destroy();
        }
        hourlyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Proyectos',
                        data: projectCounts,
                        borderColor: 'rgba(246, 7, 97, 0.9)',
                        backgroundColor: 'rgba(246, 7, 97, 0.2)',
                        fill: true,
                        tension: 0.35
                    },
                    {
                        label: 'Imágenes',
                        data: photoCounts,
                        borderColor: 'rgba(255, 255, 255, 0.45)',
                        backgroundColor: 'rgba(255, 255, 255, 0.08)',
                        fill: true,
                        tension: 0.35
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#9da5b4' }
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    const today = new Date();
    const dateInput = document.getElementById('projects-date');
    dateInput.value = formatDateInput(today);
    document.getElementById('projects-date-apply').addEventListener('click', () => {
        loadHourlyProjects(dateInput.value);
    });

    loadOverview();
    loadHourlyProjects(dateInput.value);
</script>
{% endblock %}
